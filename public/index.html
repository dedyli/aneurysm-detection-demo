<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CEREBRO: AI Stroke Triage</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .glassmorphism {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-radius: 50%;
            border-top: 4px solid #3498db;
            width: 40px;
            height: 40px;
            animation: spin 2s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-gray-900 text-white">

    <div class="min-h-screen flex flex-col">
        <!-- Header -->
        <header class="bg-gray-900/80 backdrop-blur-sm sticky top-0 z-20 border-b border-gray-700">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-16">
                    <div class="flex items-center space-x-3">
                         <svg class="h-8 w-8 text-blue-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5c1.868 0 3.64.444 5.223 1.253a9.75 9.75 0 011.635 12.049A9.75 9.75 0 0112 21.75c-5.385 0-9.75-4.365-9.75-9.75S6.615 2.25 12 2.25c.175 0 .346.002.516.006" />
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v17.25m0-17.25c-2.485 0-4.5 2.015-4.5 4.5 0 .81.223 1.57.625 2.252m5.75-6.752A4.5 4.5 0 0118 9c0 1.06-.36 2.035-.958 2.801" />
                        </svg>
                        <h1 class="text-2xl font-bold text-white">CEREBRO</h1>
                    </div>
                    <div class="hidden md:block">
                        <p class="text-sm text-blue-300">AI-Powered Multimodal Stroke Triage</p>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="container mx-auto px-4 sm:px-6 lg:px-8 py-8 flex-grow">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">

                <!-- Input Column -->
                <div class="glassmorphism rounded-xl p-6 lg:p-8 flex flex-col space-y-6 h-full">
                    <h2 class="text-xl font-semibold">Triage Input</h2>

                    <!-- Image Upload -->
                    <div>
                        <label for="ct-scan-upload" class="block text-sm font-medium text-gray-300 mb-2">1. Upload Brain CT Scan</label>
                        <div id="image-drop-area" class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-600 border-dashed rounded-md cursor-pointer hover:border-blue-400 transition-colors">
                            <div class="space-y-1 text-center w-full">
                                <div id="image-preview-container" class="relative hidden w-full h-48 mx-auto">
                                    <img id="image-preview" src="" alt="CT Scan Preview" class="mx-auto h-full w-auto rounded-md object-contain">
                                    <div id="image-overlay" class="absolute hidden rounded-full pointer-events-none" style="background: radial-gradient(circle, rgba(255,0,0,0.6) 0%, rgba(255,150,0,0.3) 50%, rgba(255,255,0,0) 70%);"></div>
                                </div>
                                <div id="upload-placeholder">
                                     <svg class="mx-auto h-12 w-12 text-gray-500" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true">
                                        <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
                                    </svg>
                                    <div class="flex text-sm text-gray-400">
                                        <p class="pl-1">Click to upload or drag and drop</p>
                                    </div>
                                    <p class="text-xs text-gray-500">PNG, JPG, WEBP</p>
                                </div>
                            </div>
                        </div>
                        <input id="ct-scan-upload" type="file" class="sr-only" accept="image/png, image/jpeg, image/webp">
                    </div>

                    <!-- Symptoms Input -->
                    <div>
                        <label for="symptoms" class="block text-sm font-medium text-gray-300">2. Patient Symptoms & History</label>
                        <textarea id="symptoms" rows="8" class="mt-1 block w-full bg-gray-800/50 border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm text-white p-3 resize-none" placeholder="e.g., 65-year-old male presenting with sudden onset of left-sided weakness and slurred speech. History of hypertension..."></textarea>
                    </div>

                    <!-- Analyze Button -->
                    <div class="pt-4">
                        <button id="analyze-button" class="w-full flex justify-center items-center py-3 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-900 focus:ring-blue-500 transition-all duration-300 disabled:opacity-50 disabled:cursor-not-allowed">
                            <span id="button-text">Analyze Case</span>
                            <div id="button-loader" class="hidden loader" style="width:20px; height:20px; border-width:2px;"></div>
                        </button>
                    </div>
                </div>

                <!-- Output Column -->
                <div id="output-container" class="glassmorphism rounded-xl p-6 lg:p-8">
                    <h2 class="text-xl font-semibold mb-6">AI Triage Analysis</h2>
                    <div id="analysis-placeholder" class="text-center text-gray-500 py-16">
                        <svg class="mx-auto h-12 w-12" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                           <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 6h9.75M10.5 6a1.5 1.5 0 11-3 0m3 0a1.5 1.5 0 10-3 0M3.75 6H7.5m3 12h9.75m-9.75 0a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m-3.75 0H7.5m9-6h3.75m-3.75 0a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m-6.75 0H7.5" />
                        </svg>
                        <p class="mt-4 text-sm">Analysis results will appear here.</p>
                    </div>
                    <div id="analysis-result" class="hidden fade-in space-y-6">
                        <!-- Triage Recommendation -->
                        <div>
                            <h3 class="text-sm font-medium text-gray-400 mb-2">Triage Recommendation</h3>
                            <div id="triage-banner" class="p-4 rounded-lg flex items-center space-x-4">
                                <div id="triage-icon" class="h-8 w-8"></div>
                                <div>
                                    <p id="triage-diagnosis" class="font-semibold text-lg"></p>
                                    <p id="triage-level" class="text-sm"></p>
                                </div>
                            </div>
                        </div>

                        <!-- Confidence Score -->
                        <div>
                            <h3 class="text-sm font-medium text-gray-400 mb-2">Confidence Score</h3>
                            <div class="w-full bg-gray-700 rounded-full h-2.5">
                                <div id="confidence-bar" class="bg-blue-500 h-2.5 rounded-full" style="width: 0%"></div>
                            </div>
                            <p id="confidence-text" class="text-right text-sm mt-1 font-mono"></p>
                        </div>
                        
                        <!-- AI Summary -->
                        <div>
                            <h3 class="text-sm font-medium text-gray-400 mb-2">Clinician Summary</h3>
                            <div id="summary-text" class="text-gray-300 text-sm leading-relaxed p-4 bg-gray-800/50 rounded-md border border-gray-700 whitespace-pre-wrap"></div>
                        </div>

                         <!-- Reset Button -->
                        <div>
                            <button id="reset-button" class="w-full flex justify-center items-center py-2 px-4 border border-gray-600 rounded-md shadow-sm text-sm font-medium text-gray-300 bg-gray-700 hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-900 focus:ring-gray-500 transition-colors">
                                Analyze New Case
                            </button>
                        </div>

                    </div>
                    <div id="error-message" class="hidden fade-in text-center text-red-400 bg-red-900/50 p-4 rounded-md"></div>
                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer class="bg-gray-900 mt-8">
            <div class="container mx-auto py-4 px-4 sm:px-6 lg:px-8 text-center text-xs text-gray-500">
                <p>&copy; 2025 CEREBRO Team | Hackathon Prototype</p>
                 <p class="mt-1">Team: Dr. Budi Hartono, Siti Aminah, Andi Wijaya</p>
            </div>
        </footer>
    </div>

<script type="module">
    // --- DOM Elements ---
    const imageDropArea = document.getElementById('image-drop-area');
    const imageUploadInput = document.getElementById('ct-scan-upload');
    const imagePreviewContainer = document.getElementById('image-preview-container');
    const imagePreview = document.getElementById('image-preview');
    const imageOverlay = document.getElementById('image-overlay');
    const uploadPlaceholder = document.getElementById('upload-placeholder');
    const symptomsInput = document.getElementById('symptoms');
    const analyzeButton = document.getElementById('analyze-button');
    const buttonText = document.getElementById('button-text');
    const buttonLoader = document.getElementById('button-loader');
    
    const outputContainer = document.getElementById('output-container');
    const placeholder = document.getElementById('analysis-placeholder');
    const resultContainer = document.getElementById('analysis-result');
    const errorMessage = document.getElementById('error-message');
    
    const triageBanner = document.getElementById('triage-banner');
    const triageIcon = document.getElementById('triage-icon');
    const triageDiagnosis = document.getElementById('triage-diagnosis');
    const triageLevel = document.getElementById('triage-level');
    
    const confidenceBar = document.getElementById('confidence-bar');
    const confidenceText = document.getElementById('confidence-text');
    const summaryText = document.getElementById('summary-text');
    const resetButton = document.getElementById('reset-button');

    let uploadedFile = null;

    // --- State Management ---
    function setUIState(state) {
        switch (state) {
            case 'loading':
                analyzeButton.disabled = true;
                buttonText.classList.add('hidden');
                buttonLoader.classList.remove('hidden');
                placeholder.classList.add('hidden');
                resultContainer.classList.add('hidden');
                errorMessage.classList.add('hidden');
                break;
            case 'result':
                analyzeButton.disabled = false;
                buttonText.classList.remove('hidden');
                buttonLoader.classList.add('hidden');
                placeholder.classList.add('hidden');
                resultContainer.classList.remove('hidden');
                errorMessage.classList.add('hidden');
                break;
            case 'error':
                 analyzeButton.disabled = false;
                buttonText.classList.remove('hidden');
                buttonLoader.classList.add('hidden');
                placeholder.classList.add('hidden');
                resultContainer.classList.add('hidden');
                errorMessage.classList.remove('hidden');
                break;
            case 'initial':
            default:
                analyzeButton.disabled = false;
                buttonText.classList.remove('hidden');
                buttonLoader.classList.add('hidden');
                placeholder.classList.remove('hidden');
                resultContainer.classList.add('hidden');
                errorMessage.classList.add('hidden');
                imagePreview.src = '';
                imagePreviewContainer.classList.add('hidden');
                uploadPlaceholder.classList.remove('hidden');
                hideOverlay();
                symptomsInput.value = '';
                uploadedFile = null;
                break;
        }
    }


    // --- Image Handling ---
    const handleFile = (file) => {
        if (file && file.type.startsWith('image/')) {
            uploadedFile = file;
            const reader = new FileReader();
            reader.onload = (e) => {
                imagePreview.src = e.target.result;
                imagePreviewContainer.classList.remove('hidden');
                uploadPlaceholder.classList.add('hidden');
            };
            reader.readAsDataURL(file);
        }
    };

    imageDropArea.addEventListener('click', () => imageUploadInput.click());
    
    // Drag and drop functionality
    imageDropArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        e.stopPropagation();
        imageDropArea.classList.add('border-blue-400');
    });
    imageDropArea.addEventListener('dragleave', (e) => {
        e.preventDefault();
        e.stopPropagation();
        imageDropArea.classList.remove('border-blue-400');
    });
    imageDropArea.addEventListener('drop', (e) => {
        e.preventDefault();
        e.stopPropagation();
        imageDropArea.classList.remove('border-blue-400');
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            handleFile(files[0]);
        }
    });

    // --- API Call Logic ---
    async function getAIAnalysis(base64Image, text) {
        // Leave apiKey as an empty string. The platform will provide it.
        const apiKey = "AIzaSyAFNjONYeiQ6HkY4RKdyeJLFpfIbAdBxJk"; 
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

        const systemPrompt = `You are an expert radiology and neurology AI assistant named CEREBRO. 
        Your task is to analyze a brain CT scan and patient notes to provide a stroke triage recommendation for clinicians in Indonesia.
        
        Analyze the provided image and text, then respond ONLY with a single, minified JSON object. Do not include any other text, markdown, or explanations.
        The JSON object must have the following structure:
        {
          "triage_level": "High" | "Moderate" | "Low" | "Critical",
          "diagnosis": "Hemorrhagic Stroke Suspected" | "Ischemic Stroke Suspected" | "No Acute Stroke Indicators" | "Other Critical Finding",
          "confidence": number,
          "summary": "A concise, professional summary for a clinician, explaining your reasoning based on visual evidence from the CT scan and the provided patient history. Mention specific findings if possible (e.g., 'hyperdensity in the left basal ganglia consistent with hemorrhage').",
          "localization": { "x": number, "y": number, "radius": number } | null
        }

        For the "localization" field:
        - If a clear anomaly (like a hemorrhage or infarct) is visible and associated with a "High" or "Critical" triage, provide its location.
        - "x" and "y" are the coordinates of the center of the anomaly, as percentages (0-100) from the top-left corner of the image.
        - "radius" is the approximate radius of the anomaly, as a percentage (0-100) of the image's shortest side.
        - If no specific anomaly is confidently located, or if the triage level is "Low" or "Moderate", return null for this field.
        `;
        
        const userPrompt = `Patient Symptoms & History: ${text}`;

        const payload = {
            systemInstruction: {
                parts: [{ text: systemPrompt }]
            },
            contents: [{
                parts: [
                    { text: userPrompt },
                    {
                        inlineData: {
                            mimeType: "image/jpeg",
                            data: base64Image
                        }
                    }
                ]
            }],
             generationConfig: {
                 responseMimeType: "application/json",
            }
        };

        // Exponential backoff for retries
        let response;
        let delay = 1000;
        for (let i = 0; i < 5; i++) {
            try {
                response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (response.ok) {
                    break;
                }
            } catch (error) {
                console.error("Fetch error:", error);
            }
            await new Promise(resolve => setTimeout(resolve, delay));
            delay *= 2;
        }

        if (!response || !response.ok) {
            throw new Error('API request failed after multiple retries.');
        }
        
        const result = await response.json();
        
        if (result.candidates && result.candidates[0].content && result.candidates[0].content.parts[0].text) {
             try {
                // The API now directly returns a JSON string, so we just need to parse it.
                return JSON.parse(result.candidates[0].content.parts[0].text);
            } catch (e) {
                console.error("Failed to parse JSON response:", result.candidates[0].content.parts[0].text);
                throw new Error("Received an invalid JSON response from the AI.");
            }
        } else {
            console.error("Unexpected API response structure:", result);
            throw new Error('Could not get a valid response from the AI model.');
        }
    }

    // --- UI Update Logic ---
    function displayResults(data) {
        const { triage_level, diagnosis, confidence, summary, localization } = data;

        // Triage Banner Styling
        const triageStyles = {
            'Critical': {
                bg: 'bg-red-800/80',
                border: 'border-red-600',
                text: 'text-red-100',
                icon: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" /></svg>`
            },
            'High': {
                bg: 'bg-red-800/80',
                border: 'border-red-600',
                text: 'text-red-100',
                icon: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" /></svg>`
            },
            'Moderate': {
                bg: 'bg-yellow-800/80',
                border: 'border-yellow-600',
                text: 'text-yellow-100',
                icon: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8"><path stroke-linecap="round" stroke-linejoin="round" d="M11.25 11.25l.041-.02a.75.75 0 011.063.852l-.708 2.836a.75.75 0 001.063.853l.041-.021M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`
            },
            'Low': {
                bg: 'bg-green-800/80',
                border: 'border-green-600',
                text: 'text-green-100',
                icon: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`
            }
        };
        const style = triageStyles[triage_level] || triageStyles['Moderate'];
        triageBanner.className = `p-4 rounded-lg flex items-center space-x-4 border ${style.bg} ${style.border} ${style.text}`;
        triageIcon.innerHTML = style.icon;
        triageDiagnosis.textContent = diagnosis;
        triageLevel.textContent = `Urgency: ${triage_level}`;
        
        // Confidence Score
        confidenceBar.style.width = `${confidence}%`;
        confidenceText.textContent = `${confidence}%`;

        // Summary
        summaryText.textContent = summary;

        // Heatmap Overlay
        if (localization && (triage_level === 'High' || triage_level === 'Critical')) {
            showOverlay(localization);
        } else {
            hideOverlay();
        }

        setUIState('result');
    }

    function showOverlay(loc) {
        const rect = imagePreview.getBoundingClientRect();
        const containerRect = imagePreviewContainer.getBoundingClientRect();

        // Calculate the actual rendered dimensions and position of the image inside the `object-contain` element
        const naturalWidth = imagePreview.naturalWidth;
        const naturalHeight = imagePreview.naturalHeight;
        const aspectRatio = naturalWidth / naturalHeight;
        
        let renderedWidth = rect.width;
        let renderedHeight = rect.height;
        let leftOffset = rect.left - containerRect.left;
        let topOffset = rect.top - containerRect.top;

        if (rect.width / rect.height > aspectRatio) { // Image is constrained by height
            renderedWidth = renderedHeight * aspectRatio;
            leftOffset += (rect.width - renderedWidth) / 2;
        } else { // Image is constrained by width
            renderedHeight = renderedWidth / aspectRatio;
            topOffset += (rect.height - renderedHeight) / 2;
        }
        
        const shortestSide = Math.min(renderedWidth, renderedHeight);
        const radiusPixels = (loc.radius / 100) * shortestSide;

        const overlaySize = radiusPixels * 2;
        const overlayX = leftOffset + (loc.x / 100) * renderedWidth - radiusPixels;
        const overlayY = topOffset + (loc.y / 100) * renderedHeight - radiusPixels;

        imageOverlay.style.width = `${overlaySize}px`;
        imageOverlay.style.height = `${overlaySize}px`;
        imageOverlay.style.top = `${overlayY}px`;
        imageOverlay.style.left = `${overlayX}px`;
        imageOverlay.classList.remove('hidden');
    }

    function hideOverlay() {
        imageOverlay.classList.add('hidden');
    }

    // --- Event Listeners ---
    analyzeButton.addEventListener('click', async () => {
        if (!uploadedFile) {
            errorMessage.textContent = 'Please upload a CT scan image.';
            setUIState('error');
            return;
        }
        const symptoms = symptomsInput.value;
        if (!symptoms || symptoms.trim() === '') {
            errorMessage.textContent = 'Please enter patient symptoms and history.';
            setUIState('error');
            return;
        }
        
        setUIState('loading');

        try {
            const base64Image = imagePreview.src.split(',')[1];
            const resultData = await getAIAnalysis(base64Image, symptoms);
            displayResults(resultData);
        } catch (error) {
            console.error('Analysis failed:', error);
            errorMessage.textContent = `An error occurred during analysis: ${error.message}`;
            setUIState('error');
        }
    });

    resetButton.addEventListener('click', () => {
        setUIState('initial');
    });

    // --- Initial State ---
    setUIState('initial');

</script>

</body>
</html>
